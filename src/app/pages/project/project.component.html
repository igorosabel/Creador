<mat-toolbar color="primary">
  <mat-toolbar-row>
    <button mat-icon-button routerLink="/main">
		<mat-icon>arrow_back</mat-icon>
	</button>
	<span>Creador: {{project.name}}</span>
	<span class="flex-space"></span>
	<button mat-icon-button (click)="saveProject()" *ngIf="!savingProject && !generatingProject">
		<mat-icon>save</mat-icon>
	</button>
	<img src="assets/loading.svg" class="loading-img" *ngIf="savingProject || generatingProject">
  </mat-toolbar-row>
</mat-toolbar>

<mat-card class="center-card-big">
  <mat-card-content>
    <mat-tab-group>

      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">assignment</mat-icon>
          Proyecto
        </ng-template>
        <div class="tab-top-margin center-card-fields">
          <mat-form-field appearance="outline">
            <mat-label>Nombre del proyecto</mat-label>
            <input matInput [(ngModel)]="project.name" required name="name">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Descripción</mat-label>
            <textarea matInput cdkTextareaAutosize #autosize="cdkTextareaAutosize" cdkAutosizeMinRows="5" cdkAutosizeMaxRows="15" [(ngModel)]="project.description" ></textarea>
          </mat-form-field>
        </div>
      </mat-tab>

      <mat-tab>
	    <ng-template mat-tab-label>
          <mat-icon class="tab-icon">build</mat-icon>
          Configuración
        </ng-template>
        <app-configuration #configuration></app-configuration>
      </mat-tab>

      <mat-tab *ngIf="hasDB">
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">view_list</mat-icon>
          Modelo
        </ng-template>
        <div class="project-header">
          <button mat-raised-button color="primary" (click)="addModel()">Añadir modelo</button>
        </div>

        <mat-card class="project-card" *ngFor="let model of projectModel; let i = index">
          <mat-card-content>
            <div class="project-model-header">
              <mat-form-field appearance="outline" class="field-key">
                <mat-label>Nombre</mat-label>
                <input matInput [(ngModel)]="model.name" name="model_name">
              </mat-form-field>
              <mat-form-field appearance="outline" class="field-key">
                <mat-label>Nombre de la tabla</mat-label>
                <input matInput [(ngModel)]="model.tableName" name="model_table_name">
              </mat-form-field>
              <button mat-raised-button color="warn" (click)="deleteModel(i)">Borrar</button>
              <button mat-raised-button color="primary" (click)="addModelRow(i, model)">Añadir campo</button>
            </div>
            <div class="project-model-rows-title">
              <button mat-button (click)="openModel(model)">
                <mat-icon class="project-model-rows-icon" [ngClass]="{'project-model-rows-icon-open':model.open}">chevron_right</mat-icon>
				Campos ({{model.rows.length}})
			  </button>
            </div>
			<div class="project-model-rows" [ngClass]="{'project-model-rows-open':model.open}">
			  <div class="project-model-row" *ngFor="let row of model.rows; let j = index">
			    <mat-form-field appearance="outline">
                  <mat-label>Nombre</mat-label>
                  <input matInput [(ngModel)]="row.name" name="row_name" class="project-model-row-name">
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Tipo</mat-label>
                  <mat-select [(value)]="row.type">
                    <mat-option *ngFor="let opt of modelRowTypes" [value]="opt.id">{{opt.name}}</mat-option>
                  </mat-select>
                </mat-form-field>
                <mat-form-field appearance="outline" *ngIf="row.type==5">
                  <mat-label>Tamaño</mat-label>
                  <input matInput [(ngModel)]="row.size" name="row_size">
                </mat-form-field>
                <mat-checkbox [(ngModel)]="row.autoIncrement" *ngIf="row.type==1">Auto increment</mat-checkbox>
                <mat-checkbox [(ngModel)]="row.nullable" *ngIf="row.type==3 || row.type==4 || row.type==5 || row.type==6 || row.type==8 || row.type==9">Null?</mat-checkbox>
                <mat-form-field appearance="outline" *ngIf="row.type==4 || row.type==5 || row.type==6 || row.type==8 || row.type==9">
                  <mat-label>Valor por defecto</mat-label>
                  <input matInput [(ngModel)]="row.defaultValue" name="row_default">
                </mat-form-field>
                <mat-form-field appearance="outline" *ngIf="row.type==7">
                  <mat-label>Valor por defecto</mat-label>
                  <mat-select [(value)]="row.defaultValue">
                    <mat-option [value]="true">True</mat-option>
                    <mat-option [value]="false">False</mat-option>
                  </mat-select>
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Referencia</mat-label>
                  <input matInput [(ngModel)]="row.ref" name="row_ref">
                </mat-form-field>
				<button mat-raised-button color="warn" class="project-model-row-delete" (click)="deleteModelRow(i, j)">Borrar</button>
                <span class="project-model-row-delete">
                  <button mat-icon-button (click)="moveRow(i, j, 'down')">
                    <mat-icon>expand_more</mat-icon>
                  </button>
				  <button mat-icon-button (click)="moveRow(i, j, 'up')">
                    <mat-icon>expand_less</mat-icon>
                  </button>
                </span>
                <mat-form-field appearance="outline" class="project-model-comment">
                  <mat-label>Comentario</mat-label>
                  <textarea matInput cdkTextareaAutosize #autosize="cdkTextareaAutosize" cdkAutosizeMinRows="2" cdkAutosizeMaxRows="15" [(ngModel)]="row.comment"></textarea>
                </mat-form-field>
			  </div>
			  <div class="project-model-row" *ngIf="model.rows.length==0">Todavía no hay ningún campo en este modelo.</div>
			</div>
          </mat-card-content>
        </mat-card>

      </mat-tab>

      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">library_add</mat-icon>
          Incluir
        </ng-template>
        <fieldset *ngFor="let inc of includeTypes" class="project-include">
          <legend>
			{{inc.name | urldecode}}
			<a *ngIf="inc.selected" href="#" class="remove-selected-include" (click)="removeSelectedInclude($event,inc)">Quitar</a>
          </legend>
          <mat-radio-group aria-label="Select an option" [(ngModel)]="inc.selected">
            <mat-list role="list">
              <mat-list-item *ngFor="let version of inc.versions">
                <div class="project-include-row">
                  {{version.version}}
                  <mat-radio-button [value]="version.id"></mat-radio-button>
                </div>
              </mat-list-item>
            </mat-list>
          </mat-radio-group>
        </fieldset>
      </mat-tab>

      <mat-tab *ngIf="project.id">
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">cloud_download</mat-icon>
          Descargar
        </ng-template>
        <div class="project-download">
          <h3>Descargar proyecto</h3>
          <p>Fecha de última modificación del proyecto: {{project.updatedAt}}</p>
          <p *ngIf="project.lastCompilationDate">Fecha de última compilación: {{project.lastCompilationDate}}</p>
          <p>
            <button mat-raised-button color="primary" [disabled]="generatingProject" (click)="generateProject()">Compilar proyecto</button>
          </p>
          <ul class="project-download-tasks" *ngIf="generatingProject || generatedProject">
            <li class="project-download-working" [ngClass]="{'project-download-done':generateStep>0}">
              <mat-icon *ngIf="generateStep>0">check_circle_outline</mat-icon>
              Crear estructura básica
            </li>
            <li [ngClass]="{'project-download-working':generateStep==1, 'project-download-done':generateStep>1}">
              <mat-icon *ngIf="generateStep>1">check_circle_outline</mat-icon>
              Crear archivo de configuración
            </li>
            <li [ngClass]="{'project-download-working':generateStep==2, 'project-download-done':generateStep>2}">
              <mat-icon *ngIf="generateStep>2">check_circle_outline</mat-icon>
              Crear modelos
            </li>
            <li [ngClass]="{'project-download-working':generateStep==3, 'project-download-done':generateStep>3}">
              <mat-icon *ngIf="generateStep>3">check_circle_outline</mat-icon>
              Añadir archivos
            </li>
            <li [ngClass]="{'project-download-working':generateStep==4, 'project-download-done':generateStep>4}">
              <mat-icon *ngIf="generateStep>4">check_circle_outline</mat-icon>
              Comprimir en Zip
            </li>
          </ul>
          <p>
            <button mat-raised-button color="primary" [disabled]="generatingProject || !project.lastCompilationDate" (click)="downloadProject()">Descargar proyecto</button>
          </p>
        </div>
      </mat-tab>
	  
	  <mat-tab *ngIf="project.id && !generatingProject">
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">delete_forever</mat-icon>
          Borrar
        </ng-template>
        <div class="project-delete">
          ¿Estás seguro de querer borrar este proyecto? Esta es una acción irreversible.
          <br>
          <button mat-raised-button color="warn" [disabled]="deletingProject" (click)="deleteProject()">
            <mat-icon class="tab-icon">delete_forever</mat-icon>
            Confirmar
          </button>
        </div>
      </mat-tab>

    </mat-tab-group>
  </mat-card-content>
</mat-card>